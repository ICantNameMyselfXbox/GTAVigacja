<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>GTAVigacja</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@3.3.1/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #north-indicator {
      position: absolute;
      width: 20px;
      height: 20px;
      pointer-events: none;
      transition: left 0.1s linear, top 0.1s linear;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <img src="logo.png" style="position:absolute; bottom:10px; left:10px; width:200px;" />
  <img src="north.png" id="north-indicator" />

  <script>
    const ORS_API_KEY = '5b3ce3597851110001cf62483ac4f0d3ed6f4364838102a41d9258c5';
    let map, startMarker, endMarker;
    let fullRouteCoords = null;
    let userPosition = null;
    let userOrientation = 0;
    let destinationSet = false;
    let followMode = false;
    const markers = [];

    function calculateDistance(a, b) {
      const dx = a[0] - b[0];
      const dy = a[1] - b[1];
      return Math.sqrt(dx * dx + dy * dy) * 111000; // ok. 1° = 111 km
    }

    function initMap() {
      map = new maplibregl.Map({
        container: 'map',
        style: 'https://api.maptiler.com/maps/0196a9ff-ca5a-72a8-b5e3-71deec7a5e00/style.json?key=xZ5mRqiLKIk5P0G37FF9',
        center: [51.11, 15.58],
        zoom: 13
      });

      map.addControl(new maplibregl.NavigationControl());

      map.on('load', () => {
        if (navigator.geolocation) {
          navigator.geolocation.watchPosition(onLocationUpdate, onLocationError, {
            enableHighAccuracy: true,
            maximumAge: 1000,
            timeout: 5000
          });
        }

        if (window.DeviceOrientationEvent) {
          window.addEventListener('deviceorientation', (e) => {
            if (e.alpha !== null) {
              userOrientation = 360 - e.alpha;
              if (startMarker) startMarker.setRotation(userOrientation);
              if (followMode && userPosition) {
                map.easeTo({ center: userPosition, bearing: userOrientation, duration: 200 });
              }
            }
          });
        }

        setInterval(updateFloatingNorthIcon, 100);
      });

      map.on('click', (e) => {
        if (!userPosition) {
          alert("Poczekaj na załadowanie lokalizacji.");
          return;
        }

        if (!destinationSet) {
          const end = [e.lngLat.lng, e.lngLat.lat];
          endMarker = addMarker(end, 'end.png');
          getRoute(userPosition, end);
          destinationSet = true;
        } else {
          clearAll();
        }
      });
    }

    function onLocationUpdate(position) {
      userPosition = [position.coords.longitude, position.coords.latitude];

      if (!startMarker) {
        const el = document.createElement('img');
        el.src = 'start.png';
        el.style.width = '32px';
        el.style.height = '32px';
        el.style.objectFit = 'contain';
        el.style.transition = 'transform 0.1s ease-out';

        el.addEventListener('click', () => {
          followMode = !followMode;
        });

        startMarker = new maplibregl.Marker({ element: el, rotationAlignment: 'map' })
          .setLngLat(userPosition)
          .addTo(map);
        map.setCenter(userPosition);
      } else {
        startMarker.setLngLat(userPosition);
      }

      if (followMode) {
        map.easeTo({ center: userPosition, bearing: userOrientation, duration: 100 });
      }

      if (endMarker && calculateDistance(userPosition, endMarker.getLngLat().toArray()) < 20) {
        endMarker.remove();
        endMarker = null;
        destinationSet = false;
        clearRoute();
        alert('Dotarłeś do celu!');
      }
    }

    function onLocationError(err) {
      console.error('Błąd lokalizacji:', err);
      alert('Nie udało się pobrać lokalizacji.');
    }

    function addMarker(coords, icon) {
      const el = document.createElement('img');
      el.src = icon;
      el.style.width = '32px';
      el.style.height = '32px';
      el.style.objectFit = 'contain';

      const marker = new maplibregl.Marker({ element: el })
        .setLngLat(coords)
        .addTo(map);
      markers.push(marker);
      return marker;
    }

    function getRoute(start, end) {
      fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': ORS_API_KEY },
        body: JSON.stringify({ coordinates: [start, end] })
      })
      .then(res => res.json())
      .then(data => {
        fullRouteCoords = data.features[0].geometry.coordinates;
        clearRoute();
        map.addSource('route', {
          type: 'geojson',
          data: {
            type: 'Feature',
            geometry: { type: 'LineString', coordinates: fullRouteCoords }
          }
        });
        map.addLayer({
          id: 'route',
          type: 'line',
          source: 'route',
          paint: { 'line-color': '#a149ed', 'line-width': 8 }
        });
      })
      .catch(err => {
        console.error('Błąd trasy:', err);
        alert('Błąd podczas pobierania trasy.');
      });
    }

    function clearRoute() {
      if (map.getLayer('route')) map.removeLayer('route');
      if (map.getSource('route')) map.removeSource('route');
      fullRouteCoords = null;
    }

    function clearAll() {
      markers.forEach(m => m.remove());
      markers.length = 0;
      if (endMarker) endMarker.remove();
      endMarker = null;
      destinationSet = false;
      clearRoute();
    }

    function updateFloatingNorthIcon() {
      const icon = document.getElementById('north-indicator');
      if (!icon) return;

      const bearing = map.getBearing();
      const angleRad = (-bearing) * Math.PI / 180;
      const w = window.innerWidth;
      const h = window.innerHeight;

      const dx = Math.sin(angleRad);
      const dy = -Math.cos(angleRad);
      const margin = 20;

      let x = w / 2;
      let y = h / 2;

      const scale = Math.min(
        Math.abs((w / 2 - margin) / dx || Infinity),
        Math.abs((h / 2 - margin) / dy || Infinity)
      );

      x += dx * scale;
      y += dy * scale;

      icon.style.left = `${x - 10}px`;
      icon.style.top = `${y - 10}px`;
    }

    document.addEventListener('DOMContentLoaded', initMap);
  </script>
</body>
</html>
