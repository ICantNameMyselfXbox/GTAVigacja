<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GTA V Navigation</title>
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }
    .icon-logo, .icon-north {
      position: absolute;
      z-index: 1000;
      cursor: pointer;
    }
    .icon-logo {
      bottom: 10px;
      left: 10px;
      width: 50px;
    }
    .icon-north {
      top: 10px;
      right: 10px;
      width: 40px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <img src="logo.png" class="icon-logo" id="logo" />
  <img src="north.png" class="icon-north" id="northIcon" />

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>
  <script>
    const map = L.map('map').setView([52.237049, 21.017532], 15);
    let followMode = false;
    let destinationMarker = null;
    let routeLayer = null;

    const tileLayer = L.tileLayer(`https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=xZ5mRqiLKIk5P0G37FF9`, {
      attribution: '&copy; MapTiler & OpenStreetMap contributors'
    }).addTo(map);

    const userIcon = L.icon({
      iconUrl: 'start.png',
      iconSize: [40, 40],
      iconAnchor: [20, 20]
    });

    const endIcon = L.icon({
      iconUrl: 'end.png',
      iconSize: [40, 40],
      iconAnchor: [20, 20]
    });

    let userMarker = L.marker([0, 0], {
      icon: userIcon,
      rotationAngle: 0,
      rotationOrigin: 'center center'
    }).addTo(map);

    function updateRoute(destLatLng) {
      const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=5b3ce3597851110001cf62483ac4f0d3ed6f4364838102a41d9258c5`;
      const body = {
        coordinates: [
          [userMarker.getLatLng().lng, userMarker.getLatLng().lat],
          [destLatLng.lng, destLatLng.lat]
        ]
      };

      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      })
      .then(response => response.json())
      .then(data => {
        if (routeLayer) map.removeLayer(routeLayer);
        const coords = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
        routeLayer = L.polyline(coords, { color: 'blue', weight: 5 }).addTo(map);
      });
    }

    map.on('click', (e) => {
      if (destinationMarker) {
        map.removeLayer(destinationMarker);
        if (routeLayer) map.removeLayer(routeLayer);
        destinationMarker = null;
        routeLayer = null;
      } else {
        destinationMarker = L.marker(e.latlng, { icon: endIcon }).addTo(map);
        updateRoute(e.latlng);
      }
    });

    document.getElementById('logo').addEventListener('click', () => {
      followMode = !followMode;
    });

    function onLocationFound(e) {
      const lat = e.latitude;
      const lng = e.longitude;
      const heading = e.heading || 0;
      userMarker.setLatLng([lat, lng]);
      userMarker.setRotationAngle(heading);
      if (followMode) {
        map.setView([lat, lng]);
        map.setBearing(heading); // Leaflet doesn't support bearing; skip rotation of map.
      }
    }

    function updateCompass(rotation) {
      const northIcon = document.getElementById('northIcon');
      northIcon.style.transform = `rotate(${-rotation}deg)`;
    }

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(position => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const heading = position.coords.heading || 0;
        onLocationFound({ latitude: lat, longitude: lng, heading });
        updateCompass(heading);
      }, null, {
        enableHighAccuracy: true
      });
    }
  </script>
</body>
</html>
